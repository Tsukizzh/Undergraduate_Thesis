# 任务3详解：ML训练数据集筛选

## 一句话总结

从任务2找到的1,591个P450结构中，**筛选出适合机器学习训练的高质量结构**。经过质量修复后，最终结果：**186个** 独特的P450可用于ML训练。

---

## 背景知识

### 为什么需要筛选？

不是所有的蛋白质结构都适合用来训练AI模型。就像训练学生做题时，需要选择**题目清晰、答案准确**的题目一样，训练AI模型也需要高质量的数据。

### 什么样的结构是"高质量"的？

| 质量指标 | 要求 | 原因 |
|----------|------|------|
| **分辨率** | ≤3.0 Å | 分辨率越小，结构越清晰精确 |
| **序列长度** | 300-1200个氨基酸 | 太短可能是片段，包含嵌合蛋白如P450 BM3 |
| **有底物绑定** | 结构中有配体分子 | 这样才能学习"酶-底物"相互作用 |
| **非冗余** | 同一蛋白只保留最好的结构 | 避免重复数据影响模型 |

### 什么是"分辨率"？

分辨率是衡量晶体结构清晰度的指标，单位是**埃**（Å，1 Å = 0.1 纳米）。

```
分辨率等级：
┌─────────────────────────────────────────┐
│  < 1.5 Å  │ 极高    │ 能看清原子位置      │
│ 1.5-2.0 Å │ 高      │ 能确定残基构象      │
│ 2.0-3.0 Å │ 中等    │ 能确定主链走向      │
│  > 3.0 Å  │ 较低    │ 只能看大致形状      │
└─────────────────────────────────────────┘
```

我们选择 ≤3.0 Å 作为阈值，保证结构足够清晰。

### 什么是"底物"和"配体"？

- **底物（Substrate）**：酶作用的目标分子，比如P450要氧化的药物分子
- **配体（Ligand）**：与蛋白质结合的任何小分子
- **辅因子（Cofactor）**：酶工作必需的辅助分子，如血红素（HEM）

我们需要区分：
```
┌────────────────────────────────────────────────────────┐
│ 底物/真正配体（我们想要的）：                            │
│   - 药物分子（如酮康唑、利福平）                         │
│   - 天然产物（如萜类、甾体）                            │
│   - 抑制剂                                            │
├────────────────────────────────────────────────────────┤
│ 辅因子/溶剂（需要排除的）：                              │
│   - HEM（血红素）- P450本身就含有                       │
│   - HOH（水分子）                                      │
│   - 缓冲盐（SO4, PO4, NaCl等）                         │
│   - 实验添加剂（甘油GOL, PEG, IPA等）                   │
└────────────────────────────────────────────────────────┘
```

---

## 任务目标

从1,591个P450结构中筛选出：
1. 分辨率足够高（≤3.0 Å）
2. 序列长度合理（300-1200 aa）
3. 有真正的底物/配体结合
4. 去除冗余（同一蛋白只保留最好的结构）

---

## 执行过程

### 第一步：质量筛选

从1,591个实体中筛除不符合质量标准的：

| 排除原因 | 排除数量 |
|----------|----------|
| 没有分辨率数据 | 7个 |
| 分辨率 > 3.0 Å | 99个 |
| 序列 < 300 氨基酸 | 59个 |
| 序列 > 1200 氨基酸 | 0个 |
| **通过质量筛选** | **1,426个** |

### 第二步：底物筛选

检查每个结构是否有真正的底物绑定：

| 类别 | 数量 |
|------|------|
| 有底物/配体绑定 | **1,146个** |
| 仅有辅因子（无底物） | 280个 |

**筛除逻辑**：
```python
# 需要排除的辅因子和溶剂列表（50+化合物）
COFACTORS_SOLVENTS = {
    "HEM", "HEC", "HEA",  # 血红素变体
    "FAD", "FMN", "NAD",  # 辅酶
    "HOH", "H2O",         # 水
    "SO4", "PO4", "CL",   # 盐离子
    "GOL", "PEG", "EDO",  # 实验添加剂
    "IPA", "MOH", "EOH",  # 醇类溶剂
    ...
}

# 如果一个结构的所有配体都在这个列表里，就排除它
```

### 第三步：去冗余

同一个蛋白质可能有多个晶体结构（不同条件下解析的）。我们只保留分辨率最好的那个。

| 指标 | 数值 |
|------|------|
| 去冗余前 | 1,146个 |
| 独特的UniProt ID数 | **186个** |
| 去冗余后 | **186个** |

**去冗余逻辑**：
```
P00183 → 有5个结构，分辨率分别是 1.6, 1.8, 2.0, 2.1, 2.5 Å
       → 只保留 1.6 Å 那个

Q2WZZ5 → 有3个结构，分辨率分别是 1.9, 2.2, 2.8 Å
       → 只保留 1.9 Å 那个
```

### 第四步：按物种分类

最终186个P450的物种分布：

| 物种类别 | 数量 | 占比 |
|----------|------|------|
| bacteria（细菌） | 100个 | 53.8% |
| other（其他） | 41个 | 22.0% |
| mammals（哺乳动物） | 33个 | 17.7% |
| plants（植物） | 7个 | 3.8% |
| fungi（真菌） | 5个 | 2.7% |

---

## 执行结果

### 筛选漏斗图

```
输入数据                    ┌─────────────────┐
(来自任务2)                 │  1,591个 实体   │
                           └────────┬────────┘
                                    │
                            质量筛选 ↓ (分辨率+序列长度)
                                    │
                           ┌────────┴────────┐
                           │  1,426个 实体   │  排除165个
                           └────────┬────────┘
                                    │
                           底物筛选 ↓ (有真正配体)
                                    │
                           ┌────────┴────────┐
                           │  1,146个 实体   │  排除280个
                           └────────┬────────┘
                                    │
                             去冗余 ↓ (每蛋白保留最佳)
                                    │
                           ┌────────┴────────┐
ML训练数据集                │   186个 P450    │  去除960个冗余
                           └─────────────────┘
```

---

## 输出文件说明

| 文件名 | 内容 | 数量 |
|--------|------|------|
| `ML训练数据集_186个.csv` | 最终筛选结果 | 186个 |
| `高质量P450全集_1426个.csv` | 通过质量筛选的全部（含冗余） | 1,426个 |
| `按物种分类/ML数据集_bacteria_100个.csv` | 细菌P450 | 100个 |
| `按物种分类/ML数据集_mammals_33个.csv` | 哺乳动物P450 | 33个 |
| `按物种分类/ML数据集_other_41个.csv` | 其他物种P450 | 41个 |
| `按物种分类/ML数据集_plants_7个.csv` | 植物P450 | 7个 |
| `按物种分类/ML数据集_fungi_5个.csv` | 真菌P450 | 5个 |

---

## 数据质量修复记录

### 三方审查发现的问题及修复

经Codex、Gemini、Claude三方独立审查，发现并修复了以下问题：

| 问题 | 优先级 | 状态 | 影响 |
|------|--------|------|------|
| 物种分类错误 | P0 | ✅ 已修复 | 159个条目被修正 |
| 序列长度限制过严 | P1 | ✅ 已修复 | 600→1200 aa |
| 辅因子列表不完整 | P2 | ✅ 已修复 | +PEG, IPA等50+化合物 |
| 配体归属逻辑 | P0 | ⚠️ 需离线 | <5Å几何验证 |
| 实体级污染 | P1 | ✅ 已有 | entity_id白名单 |
| Coverage阈值 | P2 | ⚠️ 仅Task1 | MIN_COVERAGE=0.5 |

详细报告见：[三方审查/数据质量审查报告.md](三方审查/数据质量审查报告.md)

### 主要修复内容

**1. 物种分类修复**

原始脚本使用NCBI Taxonomy ID数值范围推断物种界，导致：
- Trypanosoma（锥虫）被错误分类为"bacteria"
- Danio rerio（斑马鱼）被错误分类为"bacteria"

修复方法：建立100+物种的静态映射表，默认分类改为"other"。

**2. 序列长度修复**

原始600 aa上限排除了P450 BM3（CYP102A1，1048 aa），这是最重要的原核P450模型系统。

修复方法：上限提高到1200 aa。

**3. 辅因子列表修复**

原始列表遗漏了：
- IPA（异丙醇）- 常见晶体溶剂
- PEG（聚乙二醇）- 结晶添加剂
- MOH, EOH（甲醇、乙醇）

修复方法：扩展COFACTORS_SOLVENTS至50+化合物。

---

## 与ESIBank 389的交集

| 对比项 | ML数据集 | ESIBank |
|--------|----------|---------|
| 数量 | 186个 | 389个 |
| 结构来源 | **实验解析** | AlphaFold预测 |
| 数据类型 | 结构为主 | 功能注释为主 |
| **交集** | **25个** | **25个** |

**25个交集UniProt ID**：
```
A2TEF2, C4B644, E3VWI3, O24782, P00189, P00191, P05093, P08684,
P11511, P19099, P22680, P23295, P33261, Q06069, Q09128, Q16850,
Q6TBX7, Q6VVX0, Q6WG30, Q83WG3, Q8VQF6, Q9UNU6, Q9Y6A2, Q9ZAU3, S4UX02
```

---

## 三方审查结论

| 审查方 | 评估 | 结论 |
|--------|------|------|
| Codex | 技术验证 | ✅ 通过 |
| Gemini | 科学评估 | ✅ Approved for ML |
| Claude | 整合验证 | ✅ 推荐使用 |

**Gemini关键评估**：
> "186个P450代表'Small but Gold'数据集。物种分布现在准确反映PDB的状态。建议使用迁移学习。"

---

## ML训练建议

1. **迁移学习**：使用ESM-2/ProtTrans预训练模型
2. **分层划分**：按物种类别分层确保测试集多样性
3. **特征工程**：生成口袋图谱和嵌入向量

---

## 下一步可以做什么？

1. **交叉验证**：检查186个P450中有多少在UniProt也有功能注释
2. **数据融合**：为这186个P450补充底物特异性信息
3. **质量提升**：用实验结构替换ESIBank中的预测结构
4. **模型对比**：分别用实验结构和预测结构训练模型，比较效果差异
