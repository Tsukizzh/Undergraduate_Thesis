# EZSpecificity 数据来源与处理方式分析报告

## 分析时间
2025-12-31 02:00

---

## 一、数据来源总览

### 1.1 论文中的描述

根据EZSpecificity论文（Nature Communications）Methods部分：

> "To build the ESIBank, we first collected existing native and/or non-native substrates from BRENDA in SMILES."

> "we randomly selected an enzyme from the listed category, comprising EC number and organism name, to match the substrate obtained from UniProt"

### 1.2 实际数据来源

| 数据来源 | 用途 | 对应文件 |
|---------|------|---------|
| BRENDA数据库 | 酶-底物对关系、EC号、反应信息 | `brenda/data.csv`, `brenda/reaction.csv` |
| UniProt数据库 | 酶序列、UniProt ID | `brenda/enzymes.csv` |
| ESM-2模型 | 蛋白质序列嵌入向量 | `brenda/enzyme_features.lmdb` |
| GROVER模型 | 分子指纹 | `brenda/grover_fingerprint.lmdb` |
| AlphaFold/AlphaFill | 3D结构预测 | `brenda/structure/` |
| AutoDock-GPU | 分子对接 | 复合物结构文件 |

---

## 二、核心数据文件结构

### 2.1 enzymes.csv - 酶信息表

**路径**: `ESIBank/brenda/enzymes.csv`

**文件规模**: 25,225行（不含表头）= 25,225个独特的酶

| 列名 | 类型 | 含义 | 示例 |
|------|------|------|------|
| `sequences` | string | 蛋白质氨基酸序列 | `MSTAGKVIKCKAAVLWELKK...` |
| `uniprots` | string | UniProt数据库ID | `P07327`, `Q938F2` |

**数据示例**:
```
sequences,uniprots
MSTAGKVIKCKAAVLWELKKPFSIEEVEVAPP...,P07327
MSTAGKVIKCKAAVLWELHKPFTIEDIEVAPP...,P00329
MKTKAAVLRGVGQDWRIEEIELGDPVPGEVQV...,Q938F2
```

**关键说明**:
- 行号（0-indexed）作为enzyme索引，用于与data.csv关联
- UniProt ID可用于在UniProt数据库中查询详细蛋白质信息

---

### 2.2 data.csv - 酶-底物对数据表

**路径**: `ESIBank/brenda/data.csv`

**文件规模**: 586,515行（不含表头）= 586,515个酶-底物对

| 列名 | 类型 | 含义 | 示例 |
|------|------|------|------|
| `enzyme` | int | 酶索引（对应enzymes.csv行号） | `15164`, `13634` |
| `reaction` | int | 反应索引（对应reaction.csv行号） | `33122`, `824` |
| `label` | int | 标签：1=正样本，0=负样本 | `0`, `1` |
| `ecnumber` | string | EC酶分类号 | `3.5.2.6`, `1.14.14.1` |
| `difficulty` | int | 负样本难度（0-4），正样本为-1 | `1`, `-1` |
| `fake_ecnumber` | string | 负样本的"错误"EC号 | `3.2.1.3` |
| `structure_index` | int | 3D结构索引，-1表示无结构 | `203913`, `-1` |

**数据示例**:
```
enzyme,reaction,label,ecnumber,difficulty,fake_ecnumber,structure_index
15164,33122,0,3.5.2.6,1,3.2.1.3,203913
13634,824,0,1.1.1.37,0,3.1.1.14,-1
7894,13109,1,2.3.1.84,-1,2.3.1.84,-1
```

**关键说明**:
- `difficulty`字段表示负样本与正样本的EC号相似程度（0=完全不同，4=前4位相同）
- 负样本生成策略：从相同EC号前缀的酶中选择，制造"硬负样本"

---

### 2.3 reaction.csv - 反应信息表

**路径**: `ESIBank/brenda/reaction.csv`

| 列名 | 类型 | 含义 | 示例 |
|------|------|------|------|
| `reactions` | string | 反应SMILES（底物>>产物） | `O=C(O)CCC...>>O=CCCC...` |
| `substrates` | string | 底物SMILES | `O=C(O)CCCCCCCCCCCO` |

---

## 三、负样本生成策略

### 3.1 代码实现位置

**文件**: `src/Datasets/utils.py`
**函数**: `generate_negative_sample()`

### 3.2 算法逻辑

```python
# 核心逻辑伪代码
for each positive (enzyme, substrate, EC号):
    1. 获取所有前N位EC号相同的其他酶
    2. 随机选择其中几个作为负样本酶
    3. 确保这些酶不与该底物有真实反应关系
    4. 记录difficulty = N（EC号相同位数）
```

### 3.3 关键参数

| 参数 | 含义 | 论文设置 |
|------|------|---------|
| `same_digits` | 负样本EC号需相同的前N位 | 可配置 |
| `num_negative_enzyme` | 每个正样本生成的负样本数 | 5（论文） |

---

## 四、训练数据划分

### ⚠️ 重要校正（2025-12-31 02:50）

**原文错误**：之前错误地描述为 `brenda/all_split/` 目录
**正确路径**：模型实际使用 `brenda/random_split/` 目录

### 4.1 划分方式

采用**4折交叉验证**，文件位于 `ESIBank/brenda/random_split/`

| 文件 | 用途 | Fold 0数据量 |
|------|------|-------------|
| `training_datas_0.csv` | 训练集 | **439,887** |
| `val_datas_0.csv` | 验证集 | **43,988** |
| `testing_datas_0.csv` | 测试集 | **102,640** |

### 4.2 多数据源联合训练

根据配置文件 `complete-full-random-all-0-complex.yml`，训练时使用了8个数据源：

```yaml
train_data_path:
  - brenda/final_data/random_split/training_datas_0.csv     # 对应 brenda/random_split/
  - small_family/Duf/random_split/training_datas_0.csv      # 功能未知蛋白
  - small_family/Esterase/random_split/training_datas_0.csv # 酯酶
  - small_family/Gt_acceptor/random_split/training_datas_0.csv # 糖基转移酶
  - small_family/Nitrilase/random_split/training_datas_0.csv # 腈水解酶
  - small_family/Phosphatase/random_split/training_datas_0.csv # 磷酸酶
  - small_family/Thiolase/random_split/training_datas_0.csv # 硫解酶
  - small_family/halogenase/random_split/training_datas_0.csv # 卤化酶
```

---

## 五、P450酶数据统计

## ⚠️⚠️⚠️ 重要警告（2026-01-02）⚠️⚠️⚠️

**本节的EC号筛选方法已被证明是错误的！**

- **问题**：data.csv中的`ecnumber`字段表示**反应分类**，不是**酶分类**
- **证据**：P07327在data.csv标记为EC 1.14.14.126，但UniProt显示它是醇脱氢酶（使用Zn²⁺，不是P450！）
- **结果**：EC号筛选的4,121个"P450"中约90%是假阳性

**正确结果请参考：**
- `2026-01-02_01-46_P450精确验证/P450精确验证报告.md`
- `2026-01-02_01-46_P450精确验证/true_p450_enzymes_clean.csv`
- **真正的P450酶只有389个**（通过UniProt protein_families验证）

---

**以下内容仅作为历史记录保留，数据已过时：**

### 5.1 识别方法（⚠️ 已证明错误）

P450酶（细胞色素P450单加氧酶）的EC号范围：
- `EC 1.14.14.*` - 氧化还原酶（以成对供体作用）
- `EC 1.14.15.*` - 氧化还原酶（以NADH/NADPH为供体）

### 5.2 统计结果（第五次校正 2025-12-31 04:30）

**⚠️ 注意：第五次校正，删除halogenase（非P450，是FAD依赖型卤化酶）**

**brenda数据源（唯一含P450的数据源）：**

**Fold 0（模型实际使用）：**

| 数据集 | P450相关条目数 | 独特P450酶数 | 与训练集重叠 | 训练集未见 |
|--------|---------------|-------------|-------------|-----------|
| 全部brenda/data.csv | **15,695** | **4,899** | - | - |
| 训练集 (fold 0) | **11,809** | **4,121** | - | - |
| 测试集 (fold 0) | **2,705** | **1,565** | 1,007 | 558 |
| 验证集 (fold 0) | **1,181** | **833** | 591 | 242 |

**所有fold的P450统计（补充信息）：**

| Fold | 训练集条目 | 训练集独特酶 | 测试集条目 | 测试集独特酶 | 验证集条目 | 验证集独特酶 |
|------|-----------|-------------|-----------|-------------|-----------|-------------|
| **fold 0** | **11,809** | **4,121** | **2,705** | **1,565** | **1,181** | **833** |
| fold 1 | 11,773 | 4,098 | 2,706 | 1,548 | 1,216 | 859 |
| fold 2 | 11,757 | 4,081 | 2,731 | 1,558 | 1,207 | 854 |
| fold 3 | 11,746 | 4,123 | 2,741 | 1,544 | 1,208 | 855 |

**fold间P450酶分布**：4个fold训练集并集=4,899个，交集=1,726个

**关键发现**：测试集/验证集中共有 **778个P450酶** 模型从未见过（558+242去重后），可作为公平benchmark候选。

### 5.3 关于halogenase的说明（第五次校正）

halogenase数据集中有14个酶的EC号为`1.14.14.-`，**但这些不是P450酶**：
- 13个是**FAD依赖型卤化酶**，使用黄素（FAD）作为辅因子
- 1个（G3FLZ7）是数据噪音，属于锌指蛋白
- 真正的P450酶使用**血红素（Heme）**作为辅因子
- EC 1.14.14是一个广泛的分类，包含多种单加氧酶类型

### 5.4 Top 15 P450 EC号

| EC号 | 条目数 | 说明 |
|------|--------|------|
| 1.14.14.1 | 871 | 未分类的P450单加氧酶 |
| 1.14.14.82 | 709 | CYP81相关 |
| 1.14.14.11 | 608 | 甾类11β-羟化酶 |
| 1.14.15.16 | 544 | 胆固醇侧链裂解酶 |
| 1.14.14.9 | 527 | 甾类17α-羟化酶 |
| 1.14.14.32 | 507 | - |
| 1.14.14.137 | 454 | - |
| 1.14.14.91 | 450 | - |
| 1.14.14.154 | 428 | - |
| 1.14.14.126 | 407 | - |
| 1.14.14.80 | 372 | - |
| 1.14.15.4 | 356 | 甾类21-羟化酶 |
| 1.14.14.16 | 341 | - |
| 1.14.14.81 | 320 | - |
| 1.14.14.29 | 319 | - |

---

## 六、数据处理流程图

```
原始数据来源                    中间处理                      模型输入
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

BRENDA数据库 ─────────────────> data.csv (酶-底物对)
     │                              │
     └──> reaction.csv ────────────>│
                                    ↓
UniProt数据库 ───────────────> enzymes.csv (序列)
     │                              │
     ↓                              ↓
ESM-2模型 ──────────────────> enzyme_features.lmdb ─────> 酶序列嵌入
                                    │
底物SMILES ─────────────────────────┤
     │                              │
     ↓                              ↓
GROVER模型 ─────────────────> grover_fingerprint.lmdb ──> 分子指纹
                                    │
AlphaFold/AlphaFill ───────────────>│
     │                              │
     ↓                              ↓
AutoDock-GPU ───────────────> structure/ ───────────────> 3D复合物结构
```

---

## 七、关键代码文件

| 文件 | 作用 |
|------|------|
| `src/Datasets/brenda.py` | 数据集类定义，加载训练/验证/测试数据 |
| `src/Datasets/utils.py` | 工具函数，含负样本生成、数据预处理 |
| `src/Datasets/data_representer.py` | 数据表示器，从LMDB加载特征 |
| `src/Datasets/Structure/` | 3D结构相关处理 |

---

## 八、关键发现与结论

## ⚠️⚠️⚠️ 本节结论已过时（2026-01-02更新）⚠️⚠️⚠️

**EC号筛选方法已被证明是错误的，以下数据全部作废：**
- ~~4,121个独特P450酶~~ → 实际只有 **389个**
- ~~778个模型未见过的P450~~ → 需重新计算

**正确结论**：
- 通过UniProt protein_families验证，**真正的P450酶只有389个**
- 请参考：`2026-01-02_01-46_P450精确验证/P450精确验证报告.md`

---

**以下内容仅作为历史记录保留：**

### 8.1 P450酶在训练数据中的存在（第五次校正 2025-12-31 04:30）（⚠️ 已过时）

**~~结论：ESIBank训练数据中确实包含P450酶！~~**

**brenda数据源（唯一含P450的数据源）：**
- ~~总计15,695条P450相关的酶-底物对~~
- ~~涉及4,899个独特的P450酶~~
- ~~训练集(random_split): 11,809条，4,121个独特酶~~

**⚠️ 上述数据基于EC号筛选，已证明约90%为假阳性**

**其他7个数据源均不含P450酶**（包括halogenase，其EC 1.14.14.-酶是FAD卤化酶，非P450）

**合计（⚠️ 已过时）：**
- ~~**训练集共11,809条P450相关条目**~~
- ~~**训练集共4,121个独特P450酶**~~
- **正确数字：389个真正的P450酶**

### 8.2 数据集重叠分析（第五次校正更新）

**重要发现**：训练/测试/验证集中的P450酶存在大量重叠！

| 项目 | 数量 | 说明 |
|------|------|------|
| 测试集独特P450酶 | 1,565 | 仅brenda |
| 测试集与训练集重叠 | 1,007 (64.3%) | 这些酶模型已在训练中见过 |
| 测试集训练集未见 | **558** | **这些酶模型从未见过** |
| 验证集独特P450酶 | 833 | 仅brenda |
| 验证集与训练集重叠 | 591 (70.9%) | 这些酶模型已在训练中见过 |
| 验证集训练集未见 | **242** | **这些酶模型从未见过** |

**Benchmark候选**：测试集+验证集中共有 **778个P450酶** 模型从未见过（去重后），可作为公平benchmark的候选。

### 8.3 对Benchmark的影响

由于训练数据中包含**4,121个独特P450酶**（仅brenda数据源），使用EZSpecificity对苄基异喹啉生物碱相关P450进行benchmark时需要注意：

1. **数据泄露风险**：需检查目标P450是否已在训练集中
2. **建议操作**：提取训练集中的所有P450 UniProt ID，与目标P450进行比对
3. **若有重叠**：该P450不应用于benchmark（已见过的数据）
4. **若无重叠**：可安全用于benchmark
5. **备选候选**：如需更多未见过的P450，可从测试集/验证集中778个未见过的P450中筛选

---

## 九、后续工作

1. [x] 提取训练集中所有P450酶的UniProt ID列表 ✅ 已完成（但基于EC号，已过时）
2. [x] 验证这些UniProt ID确实对应P450酶（UniProt API查询）✅ **2026-01-02完成 - 发现EC号方法错误**
3. [ ] 与苄基异喹啉生物碱相关P450列表进行比对
4. [ ] 生成最终报告，明确哪些P450可用于benchmark

### 🎉 2026-01-02 重大更新

**已完成P450精确验证！**
- 对全部25,225个酶执行UniProt protein_families验证
- **真正的P450酶只有389个**（不是EC号筛选的4,121个）
- 详见：`2026-01-02_01-46_P450精确验证/P450精确验证报告.md`
