# P450-EZSpecificity 四条路径研究计划

> **三方协作制定** | Claude + Gemini + Codex
> **日期**: 2026-01-08
> **范围**: 路径A/B/C/D全局规划，当前专注路径A

---

## 用户配置确认

| 配置项 | 用户选择 |
|--------|---------|
| **起始步骤** | Step 0（从头开始） |
| **配体分类策略** | 自动分类 + 人工审核 |
| **GPU显存** | 8-16GB → batch_size=8 |

---

## 最新进展索引

> 本文档为**战略级规划**，具体执行细节请查阅以下文档：

| 内容 | 文档位置 |
|------|----------|
| **Path A 执行进度** | `PathA_.../进度日志.md` |
| **全局进度总览** | `全局进度日志.md` |
| **Step 2 序列提取详情** | `PathA_.../sessions/2026-01-09_Step2_.../session_log.md` |
| **Step 3 配体提取详情** | `PathA_.../sessions/2026-01-09_Step3_.../session_log.md` |
| **ESIBank vs 我们的流程对比** | Step 3 session_log 第八章 |
| **三种解决方案（A/B/C）** | Step 3 session_log 第九章 |

**当前状态**：Path A Step 3 完成，正在执行方案B（多配体展开）

---

## 零、全局目录架构

### 0.1 大目录结构（四条路径）
```
P450_EZSpecificity_研究项目/              ← 总目录
│
├── 共享资源/                             ← 四条路径共用
│   ├── source_data/                      ← 依赖数据
│   ├── literature/                       ← 文献资料
│   └── configs/                          ← 共享配置
│
├── PathA_2026-01-08_模型评估测试集构建/   ← 当前执行
│   └── [详细结构见0.2]
│
├── PathB_待定_P450专属数据集构建/         ← 路径A完成后
│   └── [预留结构见0.3]
│
├── PathC_待定_P450专属模型训练/           ← 路径B完成后
│   └── [预留结构见0.4]
│
├── PathD_待定_区域选择性预测/             ← 路径A完成后可选
│   └── [预留结构见0.5]
│
└── 全局进度日志.md                        ← 四条路径总览
```

### 0.2 Path A 详细结构（当前执行）
```
PathA_2026-01-08_模型评估测试集构建/
│
├── scripts/                    ← 执行代码
│   ├── step1_download_pdb.py
│   ├── step2_extract_sequence.py
│   ├── step3_extract_ligand.py
│   ├── step4_build_index.py
│   ├── step5_convert_pdb.py
│   ├── step6_generate_esm.py
│   ├── step7_generate_substrate_features.py
│   ├── step8_process_structure.py
│   ├── step9_run_prediction.py
│   ├── step10_analyze_results.py
│   └── utils/
│       ├── pdb_parser.py
│       ├── ligand_classifier.py
│       └── validation.py
│
├── configs/                    ← 配置文件
│   ├── paths.yaml
│   ├── exclude_list.txt
│   └── ligand_blacklist.txt
│
├── logs/                       ← 执行日志
│   ├── step1_download.log
│   └── errors/
│       └── failed_pdbs.txt
│
├── source_data/                ← 【新增】依赖数据（从提取P450过程日志复制）
│   │
│   ├── 01_核心数据/            ← 最重要，Path A必需
│   │   ├── ML训练数据集_186个.csv
│   │   ├── P450酶列表_最终版389个.csv
│   │   ├── 高质量P450全集_1426个.csv
│   │   └── 全部P450结构_1591个_物种修复后.csv
│   │
│   ├── 02_底物数据/
│   │   ├── P450酶底物反应详表_完整版.csv
│   │   └── P450_物种分类_含底物数据_完整版.csv
│   │
│   ├── 03_物种分类/
│   │   ├── P450物种分类_完整版389个.csv
│   │   └── 按物种分类/
│   │       ├── ML数据集_bacteria_100个.csv
│   │       ├── ML数据集_mammals_33个.csv
│   │       └── ...
│   │
│   ├── 04_PDB映射/
│   │   ├── 389个P450的PDB映射_完整版.csv
│   │   └── 有PDB结构的P450_去重版.csv
│   │
│   ├── 05_验证数据/
│   │   ├── 非P450酶列表_24815个.csv
│   │   └── 任务1_被排除酶抽样检查_100个.csv
│   │
│   └── README.md               ← 数据来源说明
│
├── data/                       ← 数据文件
│   ├── 00_raw/
│   │   └── pdb_files/
│   ├── 01_processed/
│   │   ├── Enzymes.csv
│   │   ├── Substrates.csv
│   │   ├── data.csv
│   │   └── ligand_classification.csv
│   ├── 02_features/
│   │   ├── enzyme_features.lmdb
│   │   ├── reaction_features.lmdb
│   │   ├── morgan_fingerprint.npy
│   │   └── grover_fingerprint.lmdb
│   └── 03_structure/
│       ├── complex/
│       └── str_tmp_data/
│
├── results/                    ← 输出结果
│   ├── predictions.csv
│   └── high_quality_id.txt
│
├── reports/                    ← 分析报告
│   ├── analysis_report.md
│   ├── figures/
│   └── tables/
│
├── checkpoints/                ← 中间检查点
│
├── sessions/                   ← 【新增】时间线记录
│   ├── 2026-01-08_14-30_Step0_确认数据位置/
│   │   ├── session_log.md      ← 本次操作记录
│   │   └── file_index.md       ← 本次产生的文件索引
│   ├── 2026-01-08_15-00_Step1_下载PDB文件/
│   │   ├── session_log.md
│   │   └── file_index.md
│   └── ...
│
└── 进度日志.md
```

### 0.3 Path B 预留结构（路径A完成后）
```
PathB_待定_P450专属数据集构建/
├── scripts/
├── configs/
├── logs/
├── data/
│   ├── brenda_data/           ← BRENDA补充数据
│   ├── negative_samples/      ← 负样本生成
│   └── final_dataset/         ← 最终数据集
├── results/
├── reports/
├── sessions/
└── 进度日志.md
```

### 0.4 Path C 预留结构（路径B完成后）
```
PathC_待定_P450专属模型训练/
├── scripts/
├── configs/
│   └── training_config.yaml
├── logs/
├── data/
├── checkpoints/               ← 训练检查点
├── models/                    ← 训练好的模型
├── results/
├── reports/
├── sessions/
└── 进度日志.md
```

### 0.5 Path D 预留结构（路径A完成后可选）
```
PathD_待定_区域选择性预测/
├── scripts/
├── configs/
├── logs/
├── data/
│   └── regioselectivity_labels/  ← 反应位点标签
├── models/
├── results/
├── reports/
├── sessions/
└── 进度日志.md
```

### 0.6 执行原则（用户要求）

| 原则 | 说明 |
|------|------|
| **多轮辩论** | 每一步都要调用Codex/Gemini进行讨论 |
| **一步一脚印** | 确保每一步正确且有迹可循 |
| **参考CLAUDE.md** | 遵循 `C:\Users\Administrator\.claude\CLAUDE.md` 中的协作流程要求 |

### 0.4 Session记录模板

每次操作创建一个session文件夹，命名格式：`YYYY-MM-DD_HH-MM_StepX_任务描述`

**session_log.md模板**：
```markdown
# Session记录

## 基本信息
- 时间：2026-01-08 14:30
- 步骤：Step 0
- 任务：确认数据位置

## 执行内容
1. [具体做了什么]
2. [调用了哪些工具]
3. [与Codex/Gemini的讨论要点]

## 产生的文件
见 file_index.md
```

**file_index.md模板**：
```markdown
# 文件索引

| 文件路径 | 说明 |
|---------|------|
| data/00_raw/xxx | 描述 |
```

### 0.5 重要路径索引

| 资源 | 路径 |
|------|------|
| **ESIBank数据集** | `G:\.shortcut-targets-by-id\173a36NiOLgXcvzvJjRDH29y2xd7Ey3Pr\ESIBank` |
| **CLAUDE.md（协作规范）** | `C:\Users\Administrator\.claude\CLAUDE.md` |
| **项目CLAUDE.md** | `C:\Users\Administrator\Desktop\EZSpecificity_Project\CLAUDE.md` |
| **提取P450过程日志目录** | `C:\Users\Administrator\Desktop\EZSpecificity_Project\提取P450过程日志` |
| **"提取P450"大任务进度日志** | `C:\Users\Administrator\Desktop\EZSpecificity_Project\提取P450过程日志\项目进度日志.md` |
| **研究手册** | `C:\Users\Administrator\Desktop\EZSpecificity_Project\P450_EZSpecificity完整研究手册_终极整合版.md` |
| **EZSpecificity论文** | `C:\Users\Administrator\Desktop\EZSpecificity_Project\Cui 等 - 2025 - Enzyme specificity prediction using cross-attention graph neural networks.pdf` |
| **预训练模型** | `C:\Users\Administrator\Desktop\EZSpecificity_Project\saved_model\model\run_0\` |
| **GROVER检查点** | `C:\Users\Administrator\Desktop\EZSpecificity_Project\data\pretrain_model\grover_large.pt` |

### 0.6 进度日志模板
```markdown
# Path A 执行进度日志

## 基本信息
- 开始时间：2026-01-08
- 目标：用161个PDB评估EZSpecificity模型

## 执行记录

### Step 0: 确认数据位置
- 状态：[ ] 未开始 / [ ] 进行中 / [ ] 已完成
- 开始时间：
- 完成时间：
- 备注：

### Step 1: 下载PDB文件
...
```

---

## 一、执行概览

### 1.1 研究路径选择

| 路径 | 目标 | 难度 | 前置条件 | 建议 |
|------|------|------|---------|------|
| **A (必做)** | 用161个PDB评估模型 | ⭐⭐ | 无 | **立即执行** |
| B | 构建P450专属数据集 | ⭐⭐⭐ | 路径A完成 | 根据A结果决定 |
| C | 训练P450专属模型 | ⭐⭐⭐⭐ | 路径B完成 | 根据A结果决定 |
| D (创新) | 区域选择性预测 | ⭐⭐⭐⭐⭐ | 路径A完成 | 如果A效果好 |

### 1.2 决策矩阵（Path A完成后）

| 结果 | 现象 | 下一步 |
|------|------|--------|
| **优秀** (Acc >85%) | 模型完美迁移 | → Path D (区域选择性创新) |
| **良好** (Acc 70-85%) | 总体能识别，细节有误 | → Path B (轻量) + Path C (微调) |
| **较差** (Acc <60%) | 接近随机猜测 | → Path B (全量) + Path C (重训) |

---

## 二、路径A：模型评估测试集构建（当前执行）

### 2.1 三阶段架构

```
阶段1: 数据清洗 (The "Clean Set" Phase)
├── Step 0: 确认数据位置
├── Step 1: 下载161个PDB文件
├── Step 2: 提取酶序列 → Enzymes.csv
├── Step 3: 提取配体信息 → Substrates.csv
├── Step 4: 构建索引表 → data.csv
└── Step 5: 转换PDB格式 → Structure/complex/

阶段2: 特征生成 (Feature Generation Phase)
├── Step 6: 生成酶特征 (ESM-2) → enzyme_features.lmdb
├── Step 7: 生成底物特征 (GROVER+Morgan) → 多个特征文件
└── Step 8: 处理结构特征 → structure_features.lmdb

阶段3: 预测与分析 (Prediction & Analysis Phase)
├── Step 9: 运行EZSpecificity预测
└── Step 10: 分析预测结果
```

---

### 2.2 Step 0: 确认数据位置并创建工作目录

#### 2.2.1 已有数据位置
数据已复制到共享资源目录，原始位置仅作参考：
```
原始位置（参考）：
EZSpecificity_Project/提取P450过程日志/2026-01-04_01-00_.../任务3_.../修复后最终版/

复制后位置（使用）：
P450_EZSpecificity_研究项目/共享资源/source_data/01_核心数据/ML训练数据集_186个.csv
```

#### 2.2.2 需要排除的25个UniProt ID
```
A2TEF2, C4B644, E3VWI3, O24782, P00189, P00191, P05093, P08684,
P11511, P19099, P22680, P23295, P33261, Q06069, Q09128, Q16850,
Q6TBX7, Q6VVX0, Q6WG30, Q83WG3, Q8VQF6, Q9UNU6, Q9Y6A2, Q9ZAU3, S4UX02
```

#### 2.2.3 创建工作目录
```bash
# 创建总目录
mkdir -p "P450_EZSpecificity_研究项目"

# 创建共享资源
mkdir -p "P450_EZSpecificity_研究项目/共享资源/source_data"
mkdir -p "P450_EZSpecificity_研究项目/共享资源/literature"
mkdir -p "P450_EZSpecificity_研究项目/共享资源/configs"

# 创建Path A目录
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/scripts/utils"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/configs"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/logs/errors"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/data/00_raw/pdb_files"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/data/01_processed"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/data/02_features"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/data/03_structure/complex"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/data/03_structure/str_tmp_data/pocket"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/data/03_structure/str_tmp_data/ligand"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/results"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/reports/figures"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/reports/tables"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/checkpoints"
mkdir -p "P450_EZSpecificity_研究项目/PathA_2026-01-08_模型评估测试集构建/sessions"

# 创建Path B/C/D预留目录
mkdir -p "P450_EZSpecificity_研究项目/PathB_待定_P450专属数据集构建"
mkdir -p "P450_EZSpecificity_研究项目/PathC_待定_P450专属模型训练"
mkdir -p "P450_EZSpecificity_研究项目/PathD_待定_区域选择性预测"
```

---

### 2.3 Step 1: 下载161个PDB文件

#### 2.3.1 操作步骤
1. 从ML训练数据集_186个.csv读取PDB ID列表
2. 排除25个与ESIBank重叠的UniProt ID对应的PDB
3. 批量下载剩余161个PDB文件

#### 2.3.2 Python脚本
```python
import pandas as pd
import requests
import os

# 排除列表
EXCLUDE_UNIPROT = {
    'A2TEF2', 'C4B644', 'E3VWI3', 'O24782', 'P00189', 'P00191',
    'P05093', 'P08684', 'P11511', 'P19099', 'P22680', 'P23295',
    'P33261', 'Q06069', 'Q09128', 'Q16850', 'Q6TBX7', 'Q6VVX0',
    'Q6WG30', 'Q83WG3', 'Q8VQF6', 'Q9UNU6', 'Q9Y6A2', 'Q9ZAU3', 'S4UX02'
}

def download_pdb(pdb_id, output_dir):
    url = f"https://files.rcsb.org/download/{pdb_id}.pdb"
    response = requests.get(url)
    if response.status_code == 200:
        with open(os.path.join(output_dir, f"{pdb_id}.pdb"), 'w') as f:
            f.write(response.text)
        return True
    return False

# 读取186个数据集，过滤掉25个重叠的
df = pd.read_csv("ML训练数据集_186个.csv")
df_filtered = df[~df['uniprot_id'].isin(EXCLUDE_UNIPROT)]
# 下载每个PDB...
```

#### 2.3.3 验证检查点
- [ ] 确认下载了161个PDB文件
- [ ] 检查文件大小（应该都>10KB）
- [ ] 验证PDB格式正确（包含ATOM行）

---

### 2.4 Step 2: 提取酶序列

#### 2.4.1 操作目标
从PDB文件提取蛋白质氨基酸序列，生成Enzymes.csv

#### 2.4.2 输出格式要求
```csv
Protein sequence
MKTAYIAKQRQISFVKSHFSRQLEERLGLIEVQAPILSRVGDGTQDNLSGAEKAVQVKVKALPDAQFEVV...
```

#### 2.4.3 关键约束
| 约束 | 值 | 影响 |
|------|-----|------|
| 最大序列长度 | 1000 氨基酸 | 超过则跳过 |
| 氨基酸类型 | 仅标准20种 | 非标准则跳过 |

#### 2.4.4 Python脚本
```python
from Bio.PDB import PDBParser
from Bio.SeqUtils import seq1

def get_sequence_from_pdb(pdb_path, chain_id='A'):
    parser = PDBParser(QUIET=True)
    structure = parser.get_structure('target', pdb_path)
    model = structure[0]

    if chain_id not in model:
        # 尝试获取第一个链
        chain = list(model.get_chains())[0]
    else:
        chain = model[chain_id]

    # 只提取标准氨基酸残基
    residues = [res for res in chain if res.id[0] == ' ']
    sequence = ''.join([seq1(res.resname) for res in residues])

    return sequence
```

#### 2.4.5 验证检查点
- [ ] 所有序列长度 ≤ 1000
- [ ] 无非标准氨基酸（X, U等）
- [ ] 序列数量 = PDB文件数量

---

### 2.5 Step 3: 提取配体信息

#### 2.5.1 操作目标
从PDB提取配体，转换为SMILES，生成Substrates.csv

#### 2.5.2 配体排除列表（黑名单）
```python
BLACKLIST = {
    # 水
    'HOH', 'WAT', 'DOD',
    # 血红素（P450辅因子）
    'HEM', 'HEC', 'HEA', 'HEB',
    # 金属离子
    'NA', 'CL', 'MG', 'CA', 'ZN', 'K', 'FE', 'MN', 'CU',
    # 结晶添加剂
    'GOL', 'EDO', 'PEG', 'PGE', 'SO4', 'PO4', 'ACT', 'DMS', 'MPD',
    # 辅酶
    'FMN', 'FAD', 'NAD', 'NAP', 'NDP'
}
```

#### 2.5.3 配体分类关键词
```python
# 底物关键词
SUBSTRATE_KEYWORDS = [
    'camphor', 'testosterone', 'progesterone', 'steroid',
    'fatty acid', 'palmit', 'oleic', 'lauric', 'vitamin',
    'cholest', 'retinoic', 'arachidonic'
]

# 抑制剂关键词
INHIBITOR_KEYWORDS = [
    'imidazole', 'azole', 'triazol', 'fluconazole',
    'ketoconazole', 'inhibitor', 'metyrapone'
]
```

#### 2.5.4 输出格式
```csv
Substrate_SMILES
CC(=O)Nc1ccc(O)cc1
c1ccccc1C(=O)O
```

#### 2.5.5 验证检查点
- [ ] SMILES可被RDKit解析
- [ ] 排除了所有黑名单配体
- [ ] 记录配体分类（底物/抑制剂/未知）

---

### 2.6 Step 4: 构建索引表

#### 2.6.1 操作目标
创建data.csv，建立酶-底物-对接结构的映射关系

#### 2.6.2 输出格式
```csv
Dock Index,Enzyme Index,Substrate Index,Label
0,0,0,1
1,1,2,1
2,0,1,1
```

#### 2.6.3 字段说明
| 字段 | 含义 |
|------|------|
| Dock Index | 对接复合物索引（对应Structure/complex/中的文件名） |
| Enzyme Index | 酶在Enzymes.csv中的行索引（0-based） |
| Substrate Index | 底物在Substrates.csv中的行索引（0-based） |
| Label | 标签（推理时可设为1，仅用于流程执行） |

#### 2.6.4 验证检查点
- [ ] 索引范围正确（不超出CSV行数）
- [ ] 每个Dock Index对应的PDB文件存在

---

### 2.7 Step 5: 转换PDB格式

#### 2.7.1 EZSpecificity要求的PDB格式
```
ATOM（蛋白质原子）
HETATM（血红素HEM - 作为辅因子保留）
COMPND    ligand.pdbqt    ← 分隔符行
ATOM（配体原子）
```

#### 2.7.2 关键要点
1. **蛋白质+辅因子在前**：ATOM和HETATM(HEM)
2. **分隔符行**：`COMPND    ***.pdbqt`
3. **配体在后**：配体原子（必须可被RDKit解析）
4. **血红素处理**：HEM作为蛋白质的一部分，不是配体

#### 2.7.3 验证检查点
- [ ] 每个PDB包含分隔符行
- [ ] 配体部分可被RDKit解析
- [ ] HEM在分隔符之前

---

### 2.8 Step 6: 生成酶特征 (ESM-2)

#### 2.8.1 操作目标
使用ESM-2模型生成蛋白质嵌入向量

#### 2.8.2 关键参数
| 参数 | 值 |
|------|-----|
| 模型 | esm2_t33_650M_UR50D |
| 表示层 | 33 |
| 输出维度 | 1280 (per residue) |
| 最大长度 | 1000 氨基酸 |

#### 2.8.3 输出格式
`enzyme_features.lmdb`
- Key: 酶索引（字符串）
- Value: pickled dict
  - `embedding`: (seq_len, 1280) numpy数组
  - `sequence`: 氨基酸编号数组

#### 2.8.4 验证检查点
- [ ] LMDB文件可正常打开
- [ ] 每个酶都有对应的embedding
- [ ] embedding维度正确

---

### 2.9 Step 7: 生成底物特征

#### 2.9.1 三个子步骤

**子步骤1: 图特征 (reaction_features.lmdb)**
```python
# 使用RDKit解析SMILES，提取分子图
# 输出：原子特征、边索引、边类型
```

**子步骤2: Morgan指纹 (morgan_fingerprint.npy)**
```python
from rdkit.Chem import AllChem
fp = AllChem.GetMorganFingerprintAsBitVect(mol, radius=2, nBits=1024)
```

**子步骤3: GROVER嵌入 (grover_fingerprint.lmdb)**
**三步流程**：
```bash
# Step 1: 生成特征
python scripts/save_features.py --data_path substrates.csv \
  --save_path features.npz --features_generator fgtasklabel

# Step 2: 构建词汇表
python scripts/build_vocab.py --data_path substrates.csv \
  --vocab_save_folder vocab --dataset_name test

# Step 3: 生成指纹
python main.py fingerprint --data_path substrates.csv \
  --features_path features.npz \
  --checkpoint_path data/pretrain_model/grover_large.pt \
  --fingerprint_source both --output grover_fp.npz
```

#### 2.9.2 验证检查点
- [ ] 所有LMDB文件可正常读取
- [ ] Morgan指纹shape = (num_substrates, 1024)
- [ ] GROVER指纹维度正确

---

### 2.10 Step 8: 处理结构特征

#### 2.10.1 三个子步骤

**子步骤1: 提取口袋和配体**
- 在COMPND分隔符处拆分PDB
- 提取配体10Å范围内的蛋白原子作为口袋
- 输出：`pocket/*.pdb`, `raw_ligand/*.sdf`

**子步骤2: 对齐SMILES与对接配体**
- 找到最大公共子结构(MCS)
- 对齐原子编号
- 输出：`ligand/*.sdf`

**子步骤3: 生成结构特征**
- 构建蛋白/配体图表示
- 输出：`structure_features.lmdb`, `str_features.lmdb`

#### 2.10.2 质量过滤
生成 `high_quality_id.txt`：
- 口袋提取成功 ∩ 配体对齐成功
- 只有这些ID用于最终预测

---

### 2.11 Step 9-10: 预测与分析

#### 2.11.1 运行预测
```bash
cd src
python main_testing.py
```

#### 2.11.2 结果解读
| 配体类型 | 预期score | 如果相反说明 |
|---------|-----------|-------------|
| 底物 | > 0 | 模型可能有问题 |
| 抑制剂 | < 0 | 模型正确识别 |
| 未知 | 需分析 | 查文献确认 |

#### 2.11.3 分析维度
1. **基本统计**：score分布、正负比例
2. **按配体类型**：底物/抑制剂的score分布
3. **失败案例**：Top-N错误预测分析

---

### 2.12 风险评估与质量检查点

| 阶段 | 风险点 | 检查点 |
|------|--------|--------|
| 数据清洗 | 将抑制剂误标为底物 | 随机抽查10个，错误率<10% |
| PDB处理 | 原子命名不标准导致建图失败 | 无Error报错，Graph节点数合理 |
| 特征生成 | 显存爆炸或时间过长 | 预跑5个样本，预估总耗时 |
| 结果分析 | 数据泄露导致结果过好 | 检查测试集底物是否在训练集中 |

---

### 2.13 关键文件索引

#### 2.13.1 需要修改/创建的文件
| 文件 | 用途 |
|------|------|
| `PathA_.../data/01_processed/Enzymes.csv` | 酶序列 |
| `PathA_.../data/01_processed/Substrates.csv` | 底物SMILES |
| `PathA_.../data/01_processed/data.csv` | 索引表 |
| `PathA_.../data/03_structure/complex/*.pdb` | 转换后的PDB |

#### 2.13.2 参考的现有文件
| 文件 | 用途 |
|------|------|
| [src/example.ipynb](src/example.ipynb) | 完整工作流程示例 |
| [src/Datasets/create_features.py](src/Datasets/create_features.py) | 特征生成代码 |
| [src/main_testing.py](src/main_testing.py) | 推理脚本 |

---

### 2.14 三方协作总结

#### Gemini贡献
- 三阶段执行战略设计
- 配体分类自动化脚本
- 决策矩阵和风险评估

#### Explore Agent贡献
- 输入文件格式详细规范
- 特征生成步骤和依赖关系
- 关键约束条件（序列长度、原子数等）

#### Claude贡献
- 整合三方意见形成统一计划
- 技术细节补充和验证
- 计划文档结构化

---

**文档版本**: v1.0 | **日期**: 2026-01-08

---

### 2.15 三方辩论关键发现（第三轮）

#### 2.15.1 最关键发现：HEM处理问题

| 发现者 | 问题 | 后果 |
|--------|------|------|
| **Codex** | `PDBProtein`只读取`ATOM`，忽略`HETATM` | HEM不会被包含在蛋白图中 |
| **Gemini** | P450活性中心变成空洞，Fe原子消失 | 模型无法预测基于金属催化的特异性 |

**必须执行的修复**：
```bash
# 将HEM的HETATM改为ATOM
sed 's/^HETATM\(.*HEM\)/ATOM  \1/' input.pdb > output.pdb
```

#### 2.15.2 文件策略共识

| 阶段 | 格式 | 说明 |
|------|------|------|
| 输入 | 单文件+COMPND | 原始PDB或合并后的复合物 |
| 中间 | 双文件 | pocket.pdb + ligand.sdf |
| 特征 | LMDB | structure_features.lmdb |

#### 2.15.3 Bond Order Loss修复

```python
from rdkit.Chem import AllChem
# 使用已知SMILES作为模板修复键级
fixed_mol = AllChem.AssignBondOrdersFromTemplate(template_mol, pdb_mol)
```

#### 2.15.4 SDF处理要求

```python
# 必须先Sanitize再保存
mol = Chem.MolFromPDBFile(ligand_pdb)
Chem.SanitizeMol(mol)  # 关键！
writer = Chem.SDWriter(output_sdf)
writer.write(mol)
```

#### 2.15.5 补充陷阱（Gemini发现）

1. **ESM-2与结构特征对齐**：创建mapping.csv校验一致性
2. **sanitize=False风险**：SDF必须在外部先Sanitize

---

### 2.16 修正后的执行标准

基于三轮辩论，Path A的执行标准修正如下：

#### 2.16.1 PDB处理流程（修正版）

```
原始PDB
    │
    ├─→ 提取蛋白质(ATOM) + HEM(HETATM→ATOM)
    │       │
    │       └─→ pocket.pdb
    │
    └─→ 提取配体(HETATM，排除HEM/水/缓冲盐)
            │
            ├─→ 用RDKit/OpenBabel修复键级
            ├─→ Sanitize
            └─→ ligand.sdf
```

#### 2.16.2 验证检查清单

- [ ] HEM原子在pocket.pdb中（检查是否有ATOM行包含HEM）
- [ ] ligand.sdf可被RDKit正确解析
- [ ] SMILES与SDF结构一致
- [ ] 索引对齐正确（Dock Index ↔ Enzyme Index ↔ Substrate Index）

---

## 三、路径B：P450专属数据集构建（待讨论）

> 待路径A完成后规划

---

## 四、路径C：P450专属模型训练（待讨论）

> 待路径B完成后规划

---

## 五、路径D：区域选择性预测（待讨论）

> 待路径A完成后可选
