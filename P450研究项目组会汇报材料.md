# P450-EZSpecificity研究：构建高质量独立测试集
## 从数据清洗到模型评估的完整流程

---

## 一、研究背景与目标

### 1.1 核心问题

**EZSpecificity（Nature 2025）对P450酶的预测效果如何？**

- ESIBank训练集包含25,225个酶，但其中**真正的P450只有389个（1.5%）**
- 模型是否对P450有足够的泛化能力？
- 需要构建**独立测试集**进行无偏评估

### 1.2 研究目标

1. **验证ESIBank中P450酶的真实数量**：原始EC号筛选方法是否可靠？
2. **构建独立测试集**：从RCSB PDB获取模型从未见过的P450结构
3. **排除数据泄露**：确保测试集与训练集无重叠
4. **准备模型评估**：完成特征提取和预测流程

### 1.3 实验总体进度

```
┌─────────────────────────────────────────────────────────────┐
│                    研究进度总览                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ✅ 已完成                                                  │
│   ├── P450精确识别（EC号→InterPro域验证）                    │
│   ├── PDB结构数据集构建（1,591→186→161）                    │
│   ├── 数据泄露排除（25个交集已剔除）                          │
│   └── Step 1：下载159个PDB文件                              │
│                                                             │
│   🔄 进行中                                                  │
│   └── 路径A：模型评估测试集构建                              │
│                                                             │
│   ⏳ 待执行                                                  │
│   └── Step 2-10：特征提取与模型预测                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、实验一：ESIBank中P450酶的精确识别

### 2.1 问题发现：EC号筛选的陷阱

**初始方法**：用EC号（1.14.14.*）筛选P450

**初始结果**：找到4,121个"P450"

**抽样验证发现严重问题**：

```
验证案例：P07327
├── data.csv中标记为：EC 1.14.14.126（P450相关EC号）
├── UniProt查询结果：
│   ├── 蛋白名：Alcohol dehydrogenase 1A（醇脱氢酶）
│   ├── 真实EC：1.1.1.1（不是1.14.14.126）
│   └── 辅因子：Zn²⁺（锌离子，不是P450特征的Heme血红素）
└── 结论：这根本不是P450酶！
```

**根本原因分析**：
- EC号分类的是**反应类型**，不是**酶的身份**
- 同一个酶可以催化多种EC类别的反应
- FAD单加氧酶、黄素蛋白单加氧酶等都可能有EC 1.14.14.*编号

### 2.2 实验方法：UniProt批量验证

**验证标准设计**（参考Codex和Gemini建议）：
1. **主标准**：UniProt `protein_families`字段包含"Cytochrome P450"
2. **备用标准**：InterPro域包含IPR001128（P450核心域）、IPR036396（P450超家族）
3. **排除条件**：排除"P450 Reductase"（电子传递伙伴，不是P450本身）

**技术实现过程**：

```
实验步骤：
1. 编写Python脚本调用UniProt REST API
2. 对25,225个酶进行批量查询（分批处理，每批150个）
3. 使用SQLite缓存避免重复查询
4. 解析返回的JSON数据，提取protein_families和InterPro域信息

遇到的技术问题：
├── 问题1：POST请求返回HTTP 400错误
│   └── 解决：改用GET请求，将参数编码到URL中
├── 问题2：批量查询URL过长
│   └── 解决：将批量大小从100减少到150
└── 问题3：网络不稳定导致查询中断
    └── 解决：使用SQLite缓存已查询结果，支持断点续传
```

**产出文件**：
- `P450识别脚本.py`：最终版识别脚本
- `UniProt查询缓存.db`：SQLite缓存（避免重复查询）

### 2.3 实验结果与三方验证

**初步筛选结果**：
| 类别 | 数量 |
|------|------|
| P450相关（protein_families含"P450"）| 410 |
| 其中P450 Reductase（需排除） | 21 |
| **真正的P450酶** | **389** |

**三方独立验证**（Claude + Codex + Gemini）：

| 验证方 | 验证内容 | 结论 |
|--------|----------|------|
| **Codex** | 数据合理性检验 | "389/25,225 (~1.54%) is plausible. The ~90% drop confirms EC-based method was over-inclusive." |
| **Gemini** | 方法论评估 | "This is the Gold Standard for bioinformatic classification. The methodology is scientifically sound." |
| **Claude** | 交叉验证 | 抽样100个被排除酶，0个含P450域（0%假阴性） |

**补充验证实验**：
1. **抽样检查**：随机抽样100个被排除酶 → 0个含P450域
2. **额外InterPro检查**：检查IPR002397/002403等 → 0个遗漏
3. **Pfam交叉验证**：用PF00067验证 → 已识别P450中99.7%含PF00067

### 2.4 实验结论

| 方法 | 识别数量 | 假阳性率 | 可靠性 |
|------|---------|---------|--------|
| EC号筛选 | 4,121 | **~90%** | ❌ 不可用 |
| InterPro验证 | **389** | **~0%** | ✅ 可靠 |

**关键结论**：ESIBank中真正的P450只有**389个**（占25,225个酶的1.5%）

**产出文件**：
- `P450酶列表_最终版389个.csv`：389个真正P450酶的UniProt ID列表
- `P450精确验证报告.md`：完整验证报告
- `P450筛选方法详解.md`：筛选逻辑详细文档

---

## 三、实验二：RCSB PDB独立测试集构建

### 3.1 实验目的

从RCSB PDB数据库获取有实验结构的P450酶，构建模型从未见过的独立测试集。

### 3.2 RCSB搜索与数据获取

**搜索条件**：
- Pfam: PF00067（P450家族）
- InterPro域验证

**搜索结果**：1,591个P450聚合物实体

**数据获取过程**：
```
1. 使用RCSB Search API进行结构化查询
2. 获取每个实体的详细元数据：
   ├── 分辨率
   ├── 序列长度
   ├── 物种来源
   ├── UniProt ID
   └── 配体信息
3. 结果存入SQLite数据库便于后续筛选
```

**筛选漏斗**：

```
1,591个P450实体（RCSB搜索结果）
    │
    ├── 第一轮：质量筛选
    │   ├── 分辨率 ≤ 3.0Å
    │   └── 序列长度 300-1200aa
    ▼
1,426个高质量结构
    │
    ├── 第二轮：配体筛选
    │   └── 排除仅有HEM/水/缓冲盐的结构
    ▼
1,146个有配体结构
    │
    ├── 第三轮：去冗余
    │   └── 每个UniProt ID保留最佳分辨率
    ▼
186个独特P450
```

**筛选过程中发现的问题与修复**（v2→v3→v4迭代）：

| 版本 | 发现的问题 | 修复内容 |
|------|-----------|----------|
| v2 | 物种分类错误（Trypanosoma被分为bacteria） | 建立静态TAXONOMY_CATEGORY_MAP |
| v3 | 序列长度上限600aa排除了P450 BM3 | 提高上限至1200aa |
| v3 | IPA（异丙醇）被当作底物 | 扩展辅因子排除列表 |
| v4 | PEG（聚乙二醇）被当作底物 | 继续扩展排除列表（+50种化合物） |

### 3.4 数据泄露排除

**问题**：如果测试集中的P450已经在ESIBank训练集中出现过，模型评估就不公平。

**排除过程**：
```
1. 提取186个PDB P450的UniProt ID
2. 与ESIBank 389个P450的UniProt ID进行比对
3. 发现25个重叠的UniProt ID（对应26条记录，因P19099有2个PDB）
4. 从测试集中排除这26条记录
5. 最终得到159个独立测试P450结构
```

**交集分析**（三方审查确认）：

初始报告显示"0交集"，经Codex审查发现Bug：
- **Bug根因**：CSV文件中`uniprot_ids`列存储为JSON数组字符串`["P00183"]`
- **错误原因**：直接字符串比对导致永远不匹配
- **修复方法**：使用`json.loads()`解析后再比对
- **正确结果**：**25个交集**

```
┌─────────────────────────────────────────────────────────────┐
│     ESIBank P450              PDB P450                      │
│    ┌───────────┐            ┌───────────┐                   │
│    │           │            │           │                   │
│    │   364     │     25     │    159    │                   │
│    │ (无PDB)   │  (交集)    │ (独立)    │                   │
│    │           │            │           │                   │
│    └───────────┘            └───────────┘                   │
│    总计：389个               总计：186个→159个               │
└─────────────────────────────────────────────────────────────┘
```

### 3.5 最终测试集物种分布

| 物种类别 | 数量 | 占比 |
|----------|------|------|
| bacteria（细菌） | 100 | 53.8% |
| other（其他） | 41 | 22.0% |
| mammals（哺乳动物） | 33 | 17.7% |
| plants（植物） | 7 | 3.8% |
| fungi（真菌） | 5 | 2.7% |

**说明**：细菌P450占主导是因为细菌P450通常是可溶性蛋白，容易结晶；植物/哺乳动物P450多是膜蛋白，结晶困难。

### 3.6 实验产出文件

| 文件 | 说明 |
|------|------|
| `全部P450结构_1591个.csv` | RCSB搜索原始结果 |
| `高质量P450全集_1426个.csv` | 质量筛选后 |
| `ML训练数据集_186个.csv` | 去冗余后 |
| `ML训练数据集_159个.csv` | 排除交集后（最终版） |
| `数据质量修复脚本.py` | v2→v4迭代修复脚本 |

---

## 四、实验三：PDB结构文件下载与验证

### 4.1 下载过程

**执行内容**：
```
1. 读取ML训练数据集_186个.csv
2. 排除25个与ESIBank重叠的UniProt ID（对应26条记录）
3. 对剩余159个PDB ID调用RCSB下载API
4. 自动处理格式差异（部分结构仅提供mmCIF格式）
```

**下载脚本逻辑**：
```python
# 伪代码示意
for pdb_id in pdb_list:
    # 优先尝试PDB格式
    url = f"https://files.rcsb.org/download/{pdb_id}.pdb"
    if download_failed:
        # 回退到mmCIF格式
        url = f"https://files.rcsb.org/download/{pdb_id}.cif"
```

### 4.2 数据验证（Codex确认）

**数据核对**：
- 原始数据：186条记录，185个唯一PDB（6ZZX重复1次）
- 排除记录：26条（25个UniProt ID，但P19099对应2个PDB）
- 最终下载：159个结构文件

**下载结果统计**：

| 格式 | 数量 | 说明 |
|------|------|------|
| .pdb | 154个 | 传统PDB格式 |
| .cif | 5个 | mmCIF格式（较新结构） |
| **总计** | **159个** | 全部下载成功 |

**文件存放位置**：`P450_EZSpecificity_研究项目/PathA_.../data/01_pdb_files/`

### 4.3 后续待执行步骤（路径A Step 2-10）

| 步骤 | 任务 | 状态 |
|------|------|------|
| Step 2 | 提取酶序列 → Enzymes.csv | 待开始 |
| Step 3 | 提取配体信息 → Substrates.csv | 待开始 |
| Step 4 | 构建索引表 → data.csv | 待开始 |
| Step 5 | 转换PDB格式（HEM处理） | 待开始 |
| Step 6 | 生成酶特征（ESM-2） | 待开始 |
| Step 7 | 生成底物特征（GROVER+Morgan） | 待开始 |
| Step 8 | 处理结构特征 | 待开始 |
| Step 9 | 运行EZSpecificity预测 | 待开始 |
| Step 10 | 分析预测结果 | 待开始 |

---

## 五、已识别的技术风险与解决方案

### 5.1 核心风险：配体≠底物

**问题**：PDB中的配体可能是底物、抑制剂、产物或结晶添加剂

**影响**：无法直接计算准确率（不知道"正确答案"是什么）

**配体类型分析**：
| 类型 | 是否为底物 | 如何识别 |
|------|-----------|----------|
| 底物 | ✅ 是 | 文献记载的催化反应物 |
| 产物 | ❌ 否 | 反应后的产物 |
| 抑制剂 | ❌ 否 | ChEMBL数据库标注 |
| 结晶添加剂 | ❌ 否 | 常见溶剂/缓冲盐 |

**解决方案**：
1. 查阅原始文献确定配体身份
2. 使用ChEMBL数据库标注已知抑制剂
3. 采用案例分析法评估模型（而非简单准确率）

### 5.2 HEM处理问题（Codex代码审查发现）

**问题发现过程**：
Codex审查EZSpecificity源代码时发现，`protein_ligand.py`只读取ATOM行

**问题本质**：
- P450的血红素（HEM）在PDB文件中标记为HETATM
- EZSpecificity代码只读取ATOM行，跳过HETATM
- 结果：活性中心变成空洞，Fe原子消失

**影响**：模型无法正确识别P450的活性位点

**解决方案**：
```
预处理步骤：将HEM相关行的HETATM改为ATOM
sed 's/^HETATM\(.*HEM\)/ATOM  \1/' input.pdb > output.pdb
```

### 5.3 数据质量问题（待核实）

| 问题 | 严重性 | 状态 |
|------|--------|------|
| 6ZZX可能是Photosystem I | 🔴 高 | 待核实 |
| 25个交集中3个不在配对数据 | 🟡 中 | 待核实 |
| nul文件存在 | 🟡 中 | 已清理 |

---

## 六、后续研究计划与决策框架

### 6.1 四路径决策矩阵

```
┌─────────────────────────────────────────────────────────────┐
│                    基于路径A结果的决策                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   路径A结果              下一步行动                           │
│   ─────────────────────────────────────────────────────     │
│   优秀（>80%）    →    路径D：区域选择性预测（创新方向）        │
│   良好（60-80%）  →    分析失败案例，考虑微调                  │
│   较差（<60%）    →    路径B+C：构建数据集+训练专属模型        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 路径D：区域选择性预测（创新方向）

**EZSpecificity做不到的事**：
- 只能预测"能否反应"（二分类）
- 不能预测"在哪里反应"（原子级别）

**区域选择性预测的价值**：
- 预测P450催化的具体反应位点
- 对药物代谢预测非常有价值
- 这是EZSpecificity无法实现的新功能

---

## 七、实验总结与阶段性成果

### 7.1 主要实验发现

| 实验 | 发现 | 数据支撑 |
|------|------|----------|
| 实验一 | EC号筛选假阳性率~90% | 4,121 → 389 |
| 实验一 | ESIBank真实P450仅389个 | 占25,225个酶的1.5% |
| 实验二 | 构建159个独立测试集 | 排除25个交集后 |
| 实验三 | 成功下载全部PDB文件 | 154个.pdb + 5个.cif |

### 7.2 已完成工作清单

| 实验阶段 | 具体工作 | 产出文件 | 状态 |
|----------|----------|----------|------|
| **实验一** | UniProt API批量查询（25,225个酶） | P450识别脚本.py | ✅ |
| | 三方验证（Claude+Codex+Gemini） | P450精确验证报告.md | ✅ |
| | P450 Reductase排除 | P450酶列表_最终版389个.csv | ✅ |
| **实验二** | RCSB PDB搜索（1,591个实体） | 全部P450结构_1591个.csv | ✅ |
| | 多轮质量筛选（v2→v3→v4） | 数据质量修复脚本.py | ✅ |
| | 数据泄露排除（25个交集） | ML训练数据集_159个.csv | ✅ |
| **实验三** | PDB文件批量下载 | 159个结构文件 | ✅ |

### 7.3 下一步工作计划

**近期目标**（路径A继续执行）：

| 步骤 | 任务 | 预期产出 |
|------|------|----------|
| Step 2 | 从PDB提取酶序列 | Enzymes.csv |
| Step 3 | 提取配体SMILES | Substrates.csv |
| Step 4 | 构建索引表 | data.csv |
| Step 5 | PDB格式转换（HEM处理） | 处理后的PDB文件 |

**中期目标**：
- 完成特征提取（ESM-2、GROVER、Morgan）
- 运行EZSpecificity预测
- 分析预测结果，评估模型在P450上的表现

---

**附录：项目文件索引**

| 类别 | 文件位置 |
|------|----------|
| 389个P450列表 | `提取P450过程日志/2026-01-02_01-46_P450精确验证/` |
| 159个测试集 | `提取P450过程日志/2026-01-04_01-00_.../任务3_.../修复后最终版/` |
| PDB文件 | `P450_EZSpecificity_研究项目/PathA_.../data/01_pdb_files/` |
| 项目进度日志 | `提取P450过程日志/项目进度日志.md` |


